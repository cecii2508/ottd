<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI è‡ªå‹•å»èƒŒè¡£æ«¥ - Vue & Firebase</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@imgly/background-removal@latest/dist/index.js"></script>
    
    <style>
        :root { --primary: #00b894; --bg: #f5f6fa; }
        body { font-family: sans-serif; background: var(--bg); display: flex; justify-content: center; padding: 20px; }
        #app { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 100%; max-width: 450px; text-align: center; }
        
        /* é è¦½å€ */
        .preview-box {
            position: relative; width: 100%; height: 400px; background: #fff;
            border: 2px solid #dfe6e9; margin-bottom: 20px; border-radius: 15px; overflow: hidden;
            background-image: radial-gradient(#dcdde1 1px, transparent 1px); background-size: 20px 20px; /* æ£‹ç›¤æ ¼èƒŒæ™¯ */
        }
        .layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain; transition: all 0.4s ease; }
        .layer-bottom { z-index: 1; }
        .layer-top    { z-index: 2; }
        .layer-outer  { z-index: 3; }

        /* æ§åˆ¶å€ */
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .upload-btn {
            background: #fff; border: 2px solid #eee; padding: 12px; border-radius: 10px;
            cursor: pointer; font-size: 14px; transition: 0.2s;
        }
        .upload-btn:hover { border-color: var(--primary); color: var(--primary); }
        .random-btn {
            grid-column: span 2; padding: 15px; background: var(--primary);
            color: white; border: none; border-radius: 10px; font-size: 16px; cursor: pointer; font-weight: bold;
        }
        
        /* è¼‰å…¥ä¸­é®ç½© */
        .loader-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); color: white; display: flex; flex-direction: column;
            align-items: center; justify-content: center; z-index: 999;
        }
        .spinner { border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid #fff; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="app">
    <div v-if="loading" class="loader-overlay">
        <div class="spinner"></div>
        <p>{{ loadingText }}</p>
        <small style="opacity: 0.7;">(é¦–æ¬¡ä½¿ç”¨ AI æ¨¡å‹ä¸‹è¼‰éœ€æ™‚è¼ƒä¹…)</small>
    </div>

    <h2>âœ¨ AI è‡ªå‹•å»èƒŒè¡£æ«¥</h2>

    <div class="preview-box">
        <img v-if="current.bottom" :src="current.bottom" class="layer layer-bottom">
        <img v-if="current.top" :src="current.top" class="layer layer-top">
        <img v-if="current.outer" :src="current.outer" class="layer layer-outer">
        <p v-if="!current.top && !current.bottom" style="margin-top: 180px; color: #b2bec3;">è«‹ä¸Šå‚³è¡£æœç…§ç‰‡</p>
    </div>

    <div class="btn-group">
        <label class="upload-btn">ğŸ‘• ä¸Šå‚³ä¸Šè¡£ <input type="file" @change="processAndUpload($event, 'top')" hidden></label>
        <label class="upload-btn">ğŸ‘– ä¸Šå‚³ä¸‹èº« <input type="file" @change="processAndUpload($event, 'bottom')" hidden></label>
        <label class="upload-btn" style="grid-column: span 2;">ğŸ§¥ ä¸Šå‚³å¤–å¥— <input type="file" @change="processAndUpload($event, 'outer')" hidden></label>
        <button class="random-btn" @click="shuffle">ğŸ”€ éš¨æ©Ÿæ­é…</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";
    import { getFirestore, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
    apiKey: "AIzaSyBA44Q62x-jTLyf4-DEkBCjyNrAY-5DzpA",
    authDomain: "ottd-69b50.firebaseapp.com",
    projectId: "ottd-69b50",
    storageBucket: "ottd-69b50.firebasestorage.app",
    messagingSenderId: "200180859742",
    appId: "1:200180859742:web:773d89e3babcb69cc285cf",
    measurementId: "G-YP5C2493RY"
  };
    const app = initializeApp(firebaseConfig);
    const storage = getStorage(app);
    const fstore = getFirestore(app);

    const { createApp, ref, onMounted } = Vue;

    createApp({
        setup() {
            const db = ref({ top: [], bottom: [], outer: [] });
            const current = ref({ top: null, bottom: null, outer: null });
            const loading = ref(false);
            const loadingText = ref("");

            onMounted(async () => {
                const querySnapshot = await getDocs(collection(fstore, "wardrobe"));
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    db.value[data.type].push(data.url);
                });
            });

            // æ ¸å¿ƒåŠŸèƒ½ï¼šAI å»èƒŒä¸¦ä¸Šå‚³
            const processAndUpload = async (event, type) => {
                const file = event.target.files[0];
                if (!file) return;

                loading.value = true;
                loadingText.value = "AI æ­£åœ¨å»èƒŒä¸­...";

                try {
                    // 1. AI å»èƒŒè™•ç† (æœƒè‡ªå‹•è½‰ç‚º PNG)
                    // imglyRemoveBackground æœƒè¿”å›ä¸€å€‹ Blob (PNG æ ¼å¼)
                    const processedBlob = await imglyRemoveBackground(file, {
                        model: 'medium', // å¯é¸ 'small' ä»¥åŠ å¿«é€Ÿåº¦ä½†å“è³ªç•¥é™
                        output: { format: 'image/png', quality: 0.8 }
                    });

                    loadingText.value = "æ­£åœ¨ä¸Šå‚³é›²ç«¯...";

                    // 2. ä¸Šå‚³è‡³ Firebase Storage
                    const storagePath = sRef(storage, `clothes/${Date.now()}.png`);
                    const snapshot = await uploadBytes(storagePath, processedBlob);
                    const url = await getDownloadURL(snapshot.ref);

                    // 3. å­˜å…¥ Firestore
                    await addDoc(collection(fstore, "wardrobe"), {
                        url, type, createdAt: new Date()
                    });

                    db.value[type].push(url);
                    current.value[type] = url;

                } catch (e) {
                    console.error(e);
                    alert("å»èƒŒæˆ–ä¸Šå‚³å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ç‹€æ³");
                } finally {
                    loading.value = false;
                    event.target.value = '';
                }
            };

            const shuffle = () => {
                const rand = (arr) => arr.length ? arr[Math.floor(Math.random() * arr.length)] : null;
                current.value.top = rand(db.value.top);
                current.value.bottom = rand(db.value.bottom);
                current.value.outer = rand(db.value.outer);
            };

            return { db, current, loading, loadingText, processAndUpload, shuffle };
        }
    }).mount('#app');
</script>

</body>
</html>